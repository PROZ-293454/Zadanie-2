package controller;

import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.GridPane;
import model.Ball;
import model.Ball.Color;
import model.Board;
import model.Board.State;
import model.ListOfBalls;
import view.Main;

import static model.Board.Move.*;
import static model.ListOfBalls.Orientation.*;
import static model.Board.State.*;
import static model.Ball.Color.*;

import java.util.ArrayList;
import java.util.List;

public class Controller {

	@FXML
	private GridPane board;

	Image arrow = new Image(Main.class.getResourceAsStream("baseline_arrow_forward_black_36dp.png"));
	private static List<ImageView> moveButtons = new ArrayList<>();


	@FXML
	void startGame() {
		Board.setState(CHOOSE_FIRST_BALL);
		addBalls();
	}

	void clickBlackBall(Ball ball) {

		State state = Board.getState();
		System.out.println(state);
		if (Board.getState() == CHOOSE_FIRST_BALL) {
			Board.addChosenBall(ball);
			state = CHOOSE_SECOND_BALL;
		}

		else if (state == CHOOSE_SECOND_BALL) {

			int x1 = Board.getChosenBall(0).getPosX();
			int y1 = Board.getChosenBall(0).getPosY();
			int x2 = ball.getPosX();
			int y2 = ball.getPosY();

			int dx=x2-x1;
			int dy=y2-y1;
			
			Board.addRestOfChosenBalls(dx, dy);
			
			if (y2 == y1) {
				
				for (int i = x2 > x1 ? 1 : -1;; i += x2 > x1 ? 1 : -1) {
					System.out.println(i);
					Ball tmpBall = myBallsList.getBall(x1 + 2 * i, y2);
					if (tmpBall != null) {
						tmpBall.setImage(Ball.whiteBallImg);
						chosenBalls.add(tmpBall);
					}
					if (2 * i == x2 - x1)
						break;
				}
				orientation = HORIZONTAL;
				state = CHOOSE_MOVE;
			}

			else if (x2 - x1 == y2 - y1) {
				for (int i = x2 > x1 ? 1 : -1;; i += x2 > x1 ? 1 : -1) {
					System.out.println(i);
					Ball tmpBall = myBallsList.getBall(x1 + i, y1 + i);
					if (tmpBall != null) {
						tmpBall.setImage(Ball.whiteBallImg);
						chosenBalls.add(tmpBall);
					}
					if (i == x2 - x1)
						break;
				}
				orientation = DIAGONAL_NW_SE;
				state = CHOOSE_MOVE;
			}

			else if (x2 - x1 == -(y2 - y1)) {
				for (int i = y2 > y1 ? 1 : -1;; i += y2 > y1 ? 1 : -1) {
					System.out.println(i);
					Ball tmpBall = myBallsList.getBall(x1 - i, y1 + i);
					if (tmpBall != null) {
						tmpBall.setImage(Ball.whiteBallImg);
						chosenBalls.add(tmpBall);
					}
					if (i == y2 - y1)
						break;
				}
				orientation = DIAGONAL_NE_WS;
				state = CHOOSE_MOVE;
			}

			int[] k = { 0, 0, 0, 0, 0, 0 };
			int numberOfBalls = chosenBalls.size();
			for (Ball tmpBall : chosenBalls) {
				if (myBallsList.getBall(tmpBall.getPosX() + 2, tmpBall.getPosY()) == null)
					k[E.id]++;
				if (myBallsList.getBall(tmpBall.getPosX() + 1, tmpBall.getPosY() + 1) == null)
					k[SE.id]++;
				if (myBallsList.getBall(tmpBall.getPosX() - 1, tmpBall.getPosY() + 1) == null)
					k[SW.id]++;
				if (myBallsList.getBall(tmpBall.getPosX() - 2, tmpBall.getPosY()) == null)
					k[W.id]++;
				if (myBallsList.getBall(tmpBall.getPosX() - 1, tmpBall.getPosY() - 1) == null)
					k[NW.id]++;
				if (myBallsList.getBall(tmpBall.getPosX() + 1, tmpBall.getPosY() - 1) == null)
					k[NE.id]++;
			}

			// System.out.println(""+k[0]+k[1]+k[2]+k[3]+k[4]+k[5]);

			if (k[E.id] == numberOfBalls) {
				ImageView btn = new ImageView(arrow);
				btn.setRotate(0);
				btn.setOnMouseClicked(e -> moveChoiceClicked(E, btn));
				moveButtons.add(btn);
				board.add(btn, x2 + 2, y2, 1, 1);
			}
			if (k[W.id] == numberOfBalls) {
				ImageView btn = new ImageView(arrow);
				btn.setRotate(180);
				moveButtons.add(btn);
				btn.setOnMouseClicked(e -> moveChoiceClicked(W, btn));
				board.add(btn, x2 - 2, y2, 1, 1);
			}
			if (k[SE.id] == numberOfBalls) {
				ImageView btn = new ImageView(arrow);
				btn.setRotate(60);
				moveButtons.add(btn);
				btn.setOnMouseClicked(e -> moveChoiceClicked(SE, btn));
				board.add(btn, x2 + 1, y2 + 1, 1, 1);
			}
			if (k[NW.id] == numberOfBalls) {
				ImageView btn = new ImageView(arrow);
				btn.setRotate(240);
				moveButtons.add(btn);
				btn.setOnMouseClicked(e -> moveChoiceClicked(NW, btn));
				board.add(btn, x2 - 1, y2 - 1, 1, 1);
			}
			if (k[NE.id] == numberOfBalls) {
				ImageView btn = new ImageView(arrow);
				btn.setRotate(300);
				moveButtons.add(btn);
				btn.setOnMouseClicked(e -> moveChoiceClicked(NE, btn));
				board.add(btn, x2 + 1, y2 - 1, 1, 1);
			}
			if (k[SW.id] == numberOfBalls) {
				ImageView btn = new ImageView(arrow);
				btn.setRotate(120);
				moveButtons.add(btn);
				btn.setOnMouseClicked(e -> moveChoiceClicked(SW, btn));
				board.add(btn, x2 - 1, y2 + 1, 1, 1);
			}
			if (orientation == HORIZONTAL) {
				for (int i = 1; i <= 3; i++) {
					Ball tmpBall = myBallsList.getBall(x2 + 2 * i, y2);
					if (tmpBall == null) {
						ImageView btn = new ImageView(arrow);
						btn.setRotate(0);
						moveButtons.add(btn);
						board.add(btn, x2 + 2, y2, 1, 1);
						break;
					} else if (tmpBall.getColor() == BLACK)
						break;

				}
				for (int i = 1; i <= 3; i++) {
					Ball tmpBall = myBallsList.getBall(x2 - 2 * i, y2);
					if (tmpBall == null) {
						ImageView btn = new ImageView(arrow);
						btn.setRotate(0);
						moveButtons.add(btn);
						board.add(btn, x2 - 2, y2, 1, 1);
						break;
					} else if (tmpBall.getColor() == BLACK)
						break;

				}
			}

			if (orientation == DIAGONAL_NE_WS) {
				for (int i = 1; i <= 3; i++) {
					Ball tmpBall = myBallsList.getBall(x2 + i, y2 - i);
					if (tmpBall == null) {
						ImageView btn = new ImageView(arrow);
						btn.setRotate(0);
						moveButtons.add(btn);
						board.add(btn, x2 + 1, y2 - 1, 1, 1);
						break;
					} else if (tmpBall.getColor() == WHITE)
						opponentToMoveBalls.add(tmpBall);
					else if (tmpBall.getColor() == BLACK)
						break;

				}
				for (int i = 1; i <= 3; i++) {
					Ball tmpBall = myBallsList.getBall(x2 - i, y2 + i);
					if (tmpBall == null) {
						ImageView btn = new ImageView(arrow);
						btn.setRotate(0);
						moveButtons.add(btn);
						board.add(btn, x2 - 1, y2 + i, 1, 1);
						break;
					} else if (tmpBall.getColor() == WHITE)
						opponentToMoveBalls.add(tmpBall);
					else if (tmpBall.getColor() == BLACK)
						break;

				}
			}

			if (orientation == DIAGONAL_NW_SE) {
				for (int i = 1; i <= 3; i++) {
					Ball tmpBall = myBallsList.getBall(x2 + i, y2 - i);
					if (tmpBall == null) {
						ImageView btn = new ImageView(arrow);
						btn.setRotate(0);
						moveButtons.add(btn);
						board.add(btn, x2 + 1, y2 - 1, 1, 1);
						break;
					} else if (tmpBall.getColor() == WHITE)
						opponentToMoveBalls.add(tmpBall);
					else if (tmpBall.getColor() == BLACK)
						break;

				}
				for (int i = 1; i <= 3; i++) {
					Ball tmpBall = myBallsList.getBall(x2 - i, y2 + i);
					if (tmpBall == null) {
						ImageView btn = new ImageView(arrow);
						btn.setRotate(0);
						moveButtons.add(btn);
						board.add(btn, x2 - 1, y2 + i, 1, 1);
						break;
					} else if (tmpBall.getColor() == WHITE)
						opponentToMoveBalls.add(tmpBall);
					else if (tmpBall.getColor() == BLACK)
						break;

				}
			}

		}

		/*
		 * else if (state == CHOOSE_MOVE) { int x2 = chosenBalls.get(chosenBalls.size()
		 * - 1).getPosX(); int x3 = ball.getPosX(); int y2 =
		 * chosenBalls.get(chosenBalls.size() - 1).getPosY(); int y3 = ball.getPosY();
		 * System.out.println(chosenBalls);
		 * 
		 * // System.out.println(y2); if (orientation == HORIZONTAL) {
		 * 
		 * if (x3 - x2 == 2) { System.out.println("Chcesz isc w prawo"); } // if(x3-x2
		 * == ) }
		 * 
		 * }
		 */

	}

	private void moveChoiceClicked(Move move, ImageView btn) {
		if (move == SE) {
			for (Ball tmpBall : chosenBalls) {
				int x = tmpBall.getPosX();
				int y = tmpBall.getPosY();
				myBallsList.remove(tmpBall);
				board.getChildren().removeAll(moveButtons);
				moveButtons.removeAll(moveButtons);
				board.getChildren().remove(tmpBall);
				Ball newBall = new Ball(BLACK, x + 1, y + 1);
				newBall.setOnMouseClicked(e -> clickBlackBall(newBall));
				board.add(newBall, x + 1, y + 1);
				myBallsList.add(newBall);

			}
		}
		if (move == SW) {
			for (Ball tmpBall : chosenBalls) {
				int x = tmpBall.getPosX();
				int y = tmpBall.getPosY();
				myBallsList.remove(tmpBall);
				board.getChildren().removeAll(moveButtons);
				moveButtons.removeAll(moveButtons);
				board.getChildren().remove(tmpBall);
				Ball newBall = new Ball(BLACK, x - 1, y + 1);
				newBall.setOnMouseClicked(e -> clickBlackBall(newBall));
				board.add(newBall, x - 1, y + 1);
				myBallsList.add(newBall);

			}
		}
		if (move == NE) {
			for (Ball tmpBall : chosenBalls) {
				int x = tmpBall.getPosX();
				int y = tmpBall.getPosY();
				myBallsList.remove(tmpBall);
				board.getChildren().removeAll(moveButtons);
				moveButtons.removeAll(moveButtons);
				board.getChildren().remove(tmpBall);
				Ball newBall = new Ball(BLACK, x + 1, y - 1);
				newBall.setOnMouseClicked(e -> clickBlackBall(newBall));
				board.add(newBall, x + 1, y - 1);
				myBallsList.add(newBall);
			}

		}
		if (move == NW) {
			for (Ball tmpBall : chosenBalls) {
				int x = tmpBall.getPosX();
				int y = tmpBall.getPosY();
				myBallsList.remove(tmpBall);
				board.getChildren().removeAll(moveButtons);
				moveButtons.removeAll(moveButtons);
				board.getChildren().remove(tmpBall);
				Ball newBall = new Ball(BLACK, x - 1, y - 1);
				newBall.setOnMouseClicked(e -> clickBlackBall(newBall));
				board.add(newBall, x - 1, y - 1);
				myBallsList.add(newBall);

			}
		}
		if (move == W) {
			for (Ball tmpBall : chosenBalls) {
				int x = tmpBall.getPosX();
				int y = tmpBall.getPosY();
				myBallsList.remove(tmpBall);
				board.getChildren().removeAll(moveButtons);
				moveButtons.removeAll(moveButtons);
				board.getChildren().remove(tmpBall);
				Ball newBall = new Ball(BLACK, x - 2, y);
				newBall.setOnMouseClicked(e -> clickBlackBall(newBall));
				board.add(newBall, x - 2, y);
				myBallsList.add(newBall);

			}
		}
		if (move == E) {
			for (Ball tmpBall : chosenBalls) {
				int x = tmpBall.getPosX();
				int y = tmpBall.getPosY();
				myBallsList.remove(tmpBall);
				board.getChildren().removeAll(moveButtons);
				moveButtons.removeAll(moveButtons);
				board.getChildren().remove(tmpBall);
				Ball newBall = new Ball(BLACK, x + 2, y);
				newBall.setOnMouseClicked(e -> clickBlackBall(newBall));
				board.add(newBall, x + 2, y);
				myBallsList.add(newBall);

			}
		}

		chosenBalls.removeAll(chosenBalls);
		state = CHOOSE_FIRST_BALL;
	}

	private void addBalls() {
		// adding my balls
		for (int i = 4; i < 13; i += 2) {
			Ball ball = new Ball(BLACK, i, 0);
			myBallsList.add(ball);
			board.add(ball, i, 0);
		}
		for (int i = 3; i < 14; i += 2) {
			Ball ball = new Ball(BLACK, i, 1);
			myBallsList.add(ball);
			board.add(ball, i, 1);
		}
		for (int i = 6; i < 11; i += 2) {
			Ball ball = new Ball(BLACK, i, 2);
			myBallsList.add(ball);
			board.add(ball, i, 2);
		}

		// adding opponent's balls
		for (int i = 4; i < 13; i += 2) {
			Ball ball = new Ball(WHITE, i, 0);
			opponentBallsList.add(ball);
			board.add(ball, i, 8);
		}
		for (int i = 3; i < 14; i += 2) {
			Ball ball = new Ball(WHITE, i, 1);
			opponentBallsList.add(ball);
			board.add(ball, i, 7);
		}
		for (int i = 6; i < 11; i += 2) {
			Ball ball = new Ball(WHITE, i, 2);
			opponentBallsList.add(ball);
			board.add(ball, i, 6);
		}

		// adding listeners to my balls
		for (Ball ball : myBallsList) {
			ball.setOnMouseClicked(e -> clickBlackBall(ball));
		}

	}

}
